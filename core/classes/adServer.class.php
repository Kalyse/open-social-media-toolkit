<?phpclass adServer {	var $db;	var $keywords;	var $usedSrcList;	var $trackid;	var $exclude;	var $adShare;					function adServer(&$db=NULL,$trackid='',$exclude='') {		if (is_null($db)) { 			require_once(PATH_CORE.'/classes/db.class.php');			$this->db=new cloudDatabase();		} else			$this->db=&$db;		$this->exclude=$exclude;		$this->trackid=$trackid;		// keep list of ads selected on this page/instance		$this->usedSrcList=array();	}		function fetchAd($size='largeBanner',$site='default') {		if (isset($_SESSION['adFree']) AND $_SESSION['adFree']==1) return '';		// pick an ad based on percentage appearance in rotation				// set up a list of ad sources already used on the page		if (count($this->usedSrcList)>0) {			$usedSrcs = implode(",", $this->usedSrcList); 			$excludeList="src NOT IN ('$usedSrcs') AND";		} else {			$excludeList='';		}		$shares=$this->db->query("SELECT src,share FROM AdShare WHERE $excludeList site='$site' AND size='$size' AND src<>'$this->exclude';");		$ad=array();		$totalShare=0;		// read into an array, add up total remaining share		while ($data=$this->db->readQ($shares)) {			$ads[]=$data;			$totalShare+=$data->share;		}				$x=rand(1,$totalShare);		$temp=0;		foreach ($ads as $curAd) {			$temp+=$curAd->share;			$src=$curAd->src;			if ($x<=$temp) 				break;		}		// get the ad for this source and size		// RAND() lets you pick from multiple options 		$fetchAd=$this->db->query("SELECT id,code FROM AdCode WHERE size='$size' AND src='$src' ORDER BY RAND() LIMIT 1;");		$ad=$this->db->readQ($fetchAd);		// replace the tracking id if it exists		$code=str_replace('{trackid}',$this->trackid,$ad->code);		// add Ad id to list of used ads		$this->usedSrcList[]=$src;		$code=str_replace('{rand}',rand(0,99),$code);		return $code;	}		function fetchUserAd($uid,$adSize='banner') {		$query=$this->db->query("SELECT adCode FROM UserAdCode WHERE uid=$uid AND adSize='$adSize';");		if ($this->db->countQ($query)==0) {			// user not registered with AdSense, send our default ad			$fetchAd=$this->db->query("SELECT id,code FROM AdCode WHERE size='$adSize' AND src='google' LIMIT 1;");			$ad=$this->db->readQ($fetchAd);			// replace the tracking id if it exists			$code=str_replace('{trackid}',$this->trackid,$ad->code);			return $code;		} else {			$data=$this->db->readQ($query);			return $data->adCode;		}	}		function flushSrcList() {		// reset used ads, pick ads for another page		unset($this->usedSrcList);	}	function cleanKeywordList($keywords) {		$keywords=str_replace(',NewsCloud,newscloud.com,news','',$keywords);		$keywords=str_replace(',','+',$keywords);		// replace spaces with plus signs		$keywords=str_replace(' ','',$keywords);		$keywords=trim($keywords,'+');		return $keywords;	}	}	?>