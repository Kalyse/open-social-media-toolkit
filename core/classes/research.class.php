<?phpclass research {		var $db;	function research(&$db=NULL) {		if (is_null($db)) { 			require_once(PATH_CORE.'/classes/db.class.php');			$this->db=new cloudDatabase();		} else			$this->db=$db;		define ('PATH_TMP',SRC_ROOT.'/sites/tmp/');		define('CRLF',"\r\n");	}		function exportStories() {		$pathTmp=PATH_TMP;		$fn=tempnam($pathTmp,'es_').'.txt';				$handle = fopen($fn, "w");		$q1=$this->db->queryC("SELECT siteContentId,title,caption,url,UNIX_TIMESTAMP(date) as t FROM  Content WHERE numComments>=2 ORDER BY t ASC;");		if ($q1!==false) {			while ($d1=$this->db->readQ($q1)) {				$str='Story: '.$d1->title.CRLF;  				$str.='-------------------------'.CRLF;					fwrite($handle,$str);				// write out comments				$q2=$this->db->queryC("SELECT Comments.userid,Content.title,UNIX_TIMESTAMP(Comments.date) as t, Comments.comments,Comments.videoid FROM Comments LEFT JOIN User ON Comments.userid=User.userid LEFT JOIN Content ON Content.siteContentId=Comments.siteContentId WHERE Comments.siteContentId=$d1->siteContentId ORDER BY Comments.date ASC;");				$str='';				if ($q2!==false) {					while ($d2=$this->db->readQ($q2)) {						$str.='User id: '.$d2->userid.CRLF.' posted this comment on '.date("D M j G:i:s T Y",$d2->t).CRLF;  						if ($d2->videoid>0) {							$str.='Comments: '.CRLF.'VIDEO COMMENT'.CRLF;							$str.='-------------------------'.CRLF;										} else {							$str.='Comments: '.CRLF.$d2->comments.CRLF;							$str.='-------------------------'.CRLF;										}					}						fwrite($handle,$str);							} else {					$str='Kinda strange, but found no comments'.CRLF;  					$str.='-------------------------'.CRLF;						fwrite($handle,$str);									}			}		} 		fclose($handle);		return 'Click to <a href="'.URL_CALLBACK.'?p=cache&erd='.rawurlencode($fn).'" target="_blank">download linked file</a>';	}		function exportChallenges() {		$pathTmp=PATH_TMP;		$fn=tempnam($pathTmp,'ec_').'.txt';				$handle = fopen($fn, "w");		$q=$this->db->queryC("SELECT userid,title,UNIX_TIMESTAMP(ChallengesCompleted.dateSubmitted) as t, evidence,comments FROM  ChallengesCompleted LEFT JOIN Challenges ON Challenges.id=ChallengesCompleted.challengeid  ORDER BY challengeid ASC,t ASC;");		$title='';		if ($q!==false) {			while ($d=$this->db->readQ($q)) {				if ($title<>$d->title) {					$title=$d->title;					$str='Challenge: '.$d->title.CRLF;  					$str.='-------------------------'.CRLF;						fwrite($handle,$str);				}								$str='User id: '.$d->userid.CRLF.' submitted challenge '.$d->title.' on '.date("D M j G:i:s T Y",$d->t).CRLF;				$str.='Evidence: '.CRLF.$d->evidence.CRLF.CRLF;				$str.='Comments from admin: '.CRLF.$d->comments.CRLF.CRLF;				$str.='-------------------------'.CRLF;								fwrite($handle,$str);			}		} 		fclose($handle);		return 'Click to <a href="'.URL_CALLBACK.'?p=cache&erd='.rawurlencode($fn).'" target="_blank">download linked file</a>';			}		function exportUsers() {		$pathTmp=PATH_TMP;		$fn=tempnam($pathTmp,'eu_').'.txt';				$handle = fopen($fn, "w");		$q1=$this->db->query("SELECT userid FROM User WHERE FIND_IN_SET(userid,'200,420,463,485,501,747,771,787,807,835,837,918,946,1031,1017,1038,1041,1047,1083,1090,1151,1170,1185,1188,1201,1213,1225,1226,1255,1299,1329,1358,1432,1465,1468,1523,1566,1567,1575,1636,1644,1723,1815,1903,1964,1969,2020,2033,2051,2058,2070,2085,2090,2136,2253,2264,2284,2307,2357,2372,2375,2382,2398,2413,2471,2501,2548,2561,2568,2575,2616,2637,2653,2681,2696,2722,2724,2779,2836,2855,2861,2905,2914,2989,3045,3055,3487') ORDER BY userid ASC;");		while ($d1=$this->db->readQ($q1)) {			$str='User id: '.$d1->userid.CRLF;  			$str.='-------------------------'.CRLF;				fwrite($handle,$str);			$str='';			// write out comments			$q2=$this->db->queryC("SELECT Comments.userid,Content.title,UNIX_TIMESTAMP(Comments.date) as t, Comments.comments,Comments.videoid FROM Comments LEFT JOIN User ON Comments.userid=User.userid LEFT JOIN Content ON Content.siteContentId=Comments.siteContentId WHERE Comments.userid={$d1->userid} ORDER BY Comments.date ASC;");			if ($q2!==false) {				while ($d2=$this->db->readQ($q2)) {					$str='User id: '.$d2->userid.CRLF.' posted this comment on '.date("D M j G:i:s T Y",$d2->t).CRLF;  					$str.='Story: '.$d2->title.CRLF;					if ($d2->videoid>0) {						$str.='Comments: '.CRLF.'VIDEO COMMENT'.CRLF;						$str.='-------------------------'.CRLF;									} else {						$str.='Comments: '.CRLF.$d2->comments.CRLF;						$str.='-------------------------'.CRLF;									}				}							} else {				$str='No comments posted by this user'.CRLF;			}			fwrite($handle,$str);			$str='';			// write out challenges submitted			$q3=$this->db->queryC("SELECT Challenges.title,UNIX_TIMESTAMP(ChallengesCompleted.dateSubmitted) as t, evidence,comments FROM  ChallengesCompleted LEFT JOIN Challenges ON Challenges.id=ChallengesCompleted.challengeid  WHERE ChallengesCompleted.userid={$d1->userid} ORDER BY t ASC;");			if ($q3!==false) {				while ($d3=$this->db->readQ($q3)) {					$str='User id: '.$d1->userid.CRLF.' submitted challenge '.$d3->title.' on '.date("D M j G:i:s T Y",$d3->t).CRLF;					$str.='Evidence: '.CRLF.$d3->evidence.CRLF.CRLF;					$str.='Comments from admin: '.CRLF.$d3->comments.CRLF.CRLF;					$str.='-------------------------'.CRLF;								}			} else {				$str='No challenges submitted by this user'.CRLF;			}			fwrite($handle,$str);			$str='';			// write out stories posted			$q4=$this->db->queryC("SELECT title,caption,url,UNIX_TIMESTAMP(date) as t FROM  Content WHERE postedById={$d1->userid} ORDER BY t ASC;");			if ($q4!==false) {				while ($d4=$this->db->readQ($q4)) {					$str='User id: '.$d1->userid.CRLF.' posted this story on '.date("D M j G:i:s T Y",$d4->t).CRLF;  					$str.='Title: '.CRLF.$d4->title.CRLF;					$str.='URL: '.CRLF.$d4->url.CRLF;					$str.='Caption: '.CRLF.$d4->caption.CRLF.CRLF;					$str.='-------------------------'.CRLF;								}			} else {				$str='No stories posted by this user'.CRLF;			}			fwrite($handle,$str);		}		fclose($handle);		return 'Click to <a href="'.URL_CALLBACK.'?p=cache&erd='.rawurlencode($fn).'" target="_blank">download linked file</a>';	}}	?>